
source [find build/OpenOCD/interface/swj-dp.tcl]

set _CHIPNAME beken7231
set _CPUTAPID 0x15968001
set _TARGETNAME $_CHIPNAME.cpu

adapter_khz 3000

reset_config none

# Add the ARM9 core debug tap
jtag newtap $_CHIPNAME cpu -irlen 4 -ircapture 0x1 -irmask 0xf -expected-id $_CPUTAPID

# Create the ".cpu" target
target create $_TARGETNAME arm966e -endian little -chain-position $_TARGETNAME

#$_TARGETNAME configure -work-area-phys 0x400000 -work-area-size 0x8000 -work-area-backup 0

arm7_9 dbgrq enable
arm7_9 dcc_downloads enable

gdb_breakpoint_override enable

# Reset target when gdb attaches
$_TARGETNAME configure -event gdb-attach {
    soft_reset_halt
}

# Shutdown OpenOCD daemon when gdb detaches
$_TARGETNAME configure -event gdb-detach {
    resume
    shutdown
}

proc flash_init { } {
    # Flash data to CPU CRC disable
    puts ">>>>>>>> Flash data to CPU CRC disable"
    mem2array tmp_arr 32 0x0080301c 1
    set reg_val [expr ($tmp_arr(0))&(~(1<<26))]
    mww 0x0080301c $reg_val

    # Flash status register data to be written
    puts ">>>>>>>> Flash status register data to be written"
    mem2array tmp_arr 32 0x0080301c 1
    set reg_val [expr ($tmp_arr(0))&(~(0xffff<<10))]
    mww 0x0080301c $reg_val    

    # CPU data writting enable
    puts ">>>>>>>> CPU data writting enable"
    mem2array tmp_arr 32 0x0080301c 1
    set reg_val [expr ($tmp_arr(0))|(1<<9)]
    mww 0x0080301c $reg_val

    # Flash operation command : WRSR2
    puts ">>>>>>>> Flash operation command : WRSR2"
    mem2array tmp_arr 32 0x00803000 1
    set reg_val $tmp_arr(0)
    # clr op_type_sw
    set reg_val [expr $reg_val&(~(0x1f<<24))]
    # op_sw, wp_value
    set reg_val [expr $reg_val|((0x07<<24)|(1<<29)|(1<<30))]
    mww 0x00803000 $reg_val
    sleep 1000
    set ready 1
    puts ">>>>>>>> Waitting for operation completed..."
    while { $ready } {
        mem2array tmp_arr 32 0x00803000 1
        set reg_val $tmp_arr(0)
        set ready [expr $reg_val&(0x01<<31)]
    }
    puts ">>>>>>>> Operation completed!"

    # Flash operation command : CE
    puts ">>>>>>>> Flash operation command : CE"
    mem2array tmp_arr 32 0x00803000 1
    set reg_val $tmp_arr(0)
    # clr op_type_sw
    set reg_val [expr $reg_val&(~(0x1f<<24))]
    # op_sw, wp_value
    set reg_val [expr $reg_val|((0x10<<24)|(1<<29)|(1<<30))]
    mww 0x00803000 $reg_val
    sleep 1000
    set ready 1
    puts ">>>>>>>> Waitting for operation completed..."
    while { $ready } {
        mem2array tmp_arr 32 0x00803000 1
        set reg_val $tmp_arr(0)
        set ready [expr $reg_val&(0x01<<31)]
    }
    puts ">>>>>>>> Operation completed!"
}
